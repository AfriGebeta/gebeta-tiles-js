<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gebeta Maps - Core Features</title>
  <!-- IMPORTANT: This css file is required for the map to be displayed correctly. -->
  <link rel="stylesheet" href="https://tiles.gebeta.app/static/gebeta-maps-lib.css" />
  <style>
    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      max-width: 300px;
    }
    .control-panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    .control-panel button {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f8f9fa;
      cursor: pointer;
      font-size: 14px;
      color: black;
    }
    .control-panel button:hover {
      background: #e9ecef;
    }
    .control-panel .info {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .control-panel .points {
      margin-top: 10px;
      color: #333;
    }
    .control-panel .points ul {
        list-style: none;
        padding: 0;
        margin: 0;
        color: #333;
    }
  </style>
</head>
<body>
  <div id="map" style="width: 100vw; height: 100vh;"></div>
  
  <div class="control-panel">
    <h3>Core Features - Fence Drawing</h3>
    <button onclick="addFencePoint()">Add Fence Point (Click Map)</button>
    <button onclick="addCustomFencePoint()">Add Custom Fence Point</button>
    <button onclick="addColoredFencePoint()">Add Blue Fence Point</button>
    <button onclick="setGreenDefaultColor()">Set Green Default Color</button>
    <button onclick="resetToRandomColors()">Reset to Random Colors</button>
    <button onclick="clearFence()">Clear Current Fence (C)</button>
    <button onclick="clearAllFences()">Clear All Fences</button>
          <div class="info">
        <strong>Instructions:</strong><br>
        â€¢ Click on the map to add fence points<br>
        â€¢ Each new fence gets a random color by default<br>
        â€¢ A colored dashed line follows your cursor while drawing<br>
        â€¢ Click on any existing fence point to close the fence<br>
        â€¢ Add at least 3 points to draw a complete fence<br>
        â€¢ Click outside a completed fence to start a new one<br>
        â€¢ Multiple fences can coexist on the map<br>
        â€¢ Press 'C' to clear the current fence<br>
        â€¢ Custom fence points can have custom images and colors
      </div>
    <div class="points">
        <strong>Fence Points:</strong><br>
        <ul id="fence-points-list">
            <!-- Fence points will be dynamically added here -->
        </ul>
    </div>
  </div>

  <!-- IMPORTANT: load the gebeta-maps.umd.js file from the tiles.gebeta.app cdn server. -->
  <!-- <script type="module" src="https://tiles.gebeta.app/static/gebeta-maps.umd.js"></script> -->
   <script src="../dist/gebeta-maps.umd.js"></script>
  <!-- this is just a utility to load the env for all examples -->
  <script src="config.js"></script>

<script>
    let gebetaMap;
    let map;
    let fencePoints = [];
    let useRandomColors = true; // Default to random colors
    let currentFenceColor = null; // Track current fence color

    document.addEventListener('DOMContentLoaded', () => {
        const config = loadConfig();
        const MY_GEBETA_API_KEY = config.GEBETA_API_KEY;
        
        gebetaMap = new GebetaMaps({ 
            apiKey: MY_GEBETA_API_KEY
        });

        map = gebetaMap.init({
            container: 'map',
            center: [38.7685, 9.0161],
            zoom: 15,
        });

        map.on('load', () => {
            gebetaMap.addNavigationControls();
        });

        gebetaMap.on('click', (e) => {
            const lngLat = [e.lngLat.lng, e.lngLat.lat];
            
            // If we have a completed fence and click is outside, clear everything and start fresh
            if (gebetaMap.isFenceCompleted() && !gebetaMap.isPointInsideFence(lngLat)) {
                console.log('Clearing old fence and markers...');
                
                // Clear the current fence
                gebetaMap.clearFence();
                
                // Clear all markers using the built-in method
                gebetaMap.clearAllMarkers();
                
                // Reset the fence points array and UI
                fencePoints = [];
                const fencePointsList = document.getElementById('fence-points-list');
                if (fencePointsList) {
                    fencePointsList.innerHTML = '';
                    console.log('Cleared fence points list');
                }
                
                // Generate new random color for the new fence if random colors are enabled
                if (useRandomColors) {
                    currentFenceColor = generateRandomColor();
                    console.log('Generated new random color for fence:', currentFenceColor);
                }
                
                // Reset the info panel
                const infoPanel = document.querySelector('.info');
                if (infoPanel) {
                    infoPanel.innerHTML = `
                        <strong>Instructions:</strong><br>
                        â€¢ Click on the map to add fence points<br>
                        â€¢ Each new fence gets a random color by default<br>
                        â€¢ A colored dashed line follows your cursor while drawing<br>
                        â€¢ Click on any existing fence point to close the fence<br>
                        â€¢ Add at least 3 points to draw a complete fence<br>
                        â€¢ Click outside a completed fence to start a new one<br>
                        â€¢ Press 'C' to clear the current fence<br>
                        â€¢ Custom fence points can have custom images and colors
                    `;
                }
                
                console.log('Cleared old fence and markers, starting new fence');
            }
            
            // Generate color for first fence if random colors are enabled and no color is set yet
            if (useRandomColors && currentFenceColor === null && fencePoints.length === 0) {
                currentFenceColor = generateRandomColor();
                console.log('Generated first random color for fence:', currentFenceColor);
            }
            
            // Add the fence point (this will be the first point of the new fence if we just cleared)
            gebetaMap.addFencePoint(lngLat, null, null, currentFenceColor);
            fencePoints.push(lngLat)

            console.log('Added fence point:', lngLat);
            // Update the fence points list in the control panel
            const fencePointsList = document.getElementById('fence-points-list');
            if (fencePointsList) {
                const listItem = document.createElement('li');
                listItem.textContent = `Point ${fencePoints.length}: [${lngLat[1].toFixed(4)}, ${lngLat[0].toFixed(4)}]`;
                fencePointsList.appendChild(listItem);
            }
            // Check if fence is completed after adding the point
            if (gebetaMap.isFenceCompleted()) {
                console.log('ðŸŽ‰ Fence completed!');
                // add info about fence completion
                const fencePointList = document.getElementById('fence-points-list');
                if (fencePointList) {
                  const paragraph = document.createElement('p');
                    paragraph.textContent = `Fence completed with ${fencePoints.length} points.`;
                    fencePointList.appendChild(paragraph);
                }
                
                // Update the info panel to show completion
                const infoPanel = document.querySelector('.info');
                if (infoPanel) {
                    infoPanel.innerHTML = `
                        <strong>âœ… Fence Completed!</strong><br>
                        â€¢ Click outside the fence to start a new one<br>
                        â€¢ Press 'C' to clear the current fence<br>
                        â€¢ Add at least 3 points to draw a complete fence
                    `;
                }
                
                // You can add any custom logic here when fence is completed
                // For example:
                // - Save the fence coordinates to a database
                // - Enable other UI controls
                // - Trigger analytics events
                // - etc.
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'c') {
                gebetaMap.clearFence();
            }
        });

        map.on('error', (e) => {
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = `<div style="padding: 20px; text-align: center;">
                    <h2>Could not load map style</h2>
                    <p>Please ensure the style server at <code>https://tiles.gebeta.app</code> is reachable.</p>
                </div>`;
            }
        });
    });

    function addFencePoint() {
        if (!gebetaMap) return;
        console.log('Click on the map to add fence points');
    }

    function addCustomFencePoint() {
        if (!gebetaMap) return;
        
        // Add a fence point with custom image and click handler
        const customImage = 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png';
        gebetaMap.addFencePoint(
            [38.7650, 9.0140],
            customImage,

            (lngLat, marker, event) => {
                console.log('Custom fence point clicked:', lngLat);
                alert(`Custom fence point at: ${lngLat[1].toFixed(4)}, ${lngLat[0].toFixed(4)}`);
            }
        );
        
        console.log('Added custom fence point with click handler');
    }

    function addColoredFencePoint() {
        if (!gebetaMap) return;
        
        // Add a fence point with a custom color (blue)
        const customImage = 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png';
        gebetaMap.addFencePoint(
            [38.7700, 9.0200],
            customImage,
            (lngLat, marker, event) => {
                console.log('Blue fence point clicked:', lngLat);
                alert(`Blue fence point at: ${lngLat[1].toFixed(4)}, ${lngLat[0].toFixed(4)}`);
            },
            '#0066cc' // Blue color
        );
        
        console.log('Added blue fence point');
    }

    function setGreenDefaultColor() {
        if (!gebetaMap) return;
        
        // Set the default color for new fences to green
        gebetaMap.setFenceDefaultColor('#00cc00');
        useRandomColors = false; // Disable random colors
        currentFenceColor = '#00cc00';
        console.log('Set default fence color to green');
        alert('Default fence color set to green. New fences will be green.');
    }

    function generateRandomColor() {
        // Generate a random color with good contrast
        const colors = [
            '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff',
            '#ff6600', '#6600ff', '#00ff66', '#ff0066', '#0066ff', '#66ff00',
            '#ff9900', '#9900ff', '#00ff99', '#ff0099', '#0099ff', '#99ff00',
            '#cc6600', '#6600cc', '#00cc66', '#cc0066', '#0066cc', '#66cc00'
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    function resetToRandomColors() {
        if (!gebetaMap) return;
        
        useRandomColors = true;
        currentFenceColor = null;
        gebetaMap.setFenceDefaultColor('#ff0000'); // Reset to default red
        console.log('Reset to random colors mode');
        alert('Reset to random colors mode. Each new fence will have a random color.');
    }

    function clearFence() {
        if (!gebetaMap) return;
        gebetaMap.clearFence();
        console.log('Fence cleared');
        
        // Reset the info panel
        const infoPanel = document.querySelector('.info');
        if (infoPanel) {
            infoPanel.innerHTML = `
                <strong>Instructions:</strong><br>
                â€¢ Click on the map to add fence points<br>
                â€¢ Each new fence gets a random color by default<br>
                â€¢ A colored dashed line follows your cursor while drawing<br>
                â€¢ Click on any existing fence point to close the fence<br>
                â€¢ Add at least 3 points to draw a complete fence<br>
                â€¢ Click outside a completed fence to start a new one<br>
                â€¢ Press 'C' to clear the fence<br>
                â€¢ Custom fence points can have custom images and colors
            `;
        }
    }

    function clearAllFences() {
        if (!gebetaMap) return;
        gebetaMap.clearAllFences();
        console.log('All fences cleared');
        
        // Reset the info panel
        const infoPanel = document.querySelector('.info');
        if (infoPanel) {
            infoPanel.innerHTML = `
                <strong>Instructions:</strong><br>
                â€¢ Click on the map to add fence points<br>
                â€¢ Each new fence gets a random color by default<br>
                â€¢ A colored dashed line follows your cursor while drawing<br>
                â€¢ Click on any existing fence point to close the fence<br>
                â€¢ Add at least 3 points to draw a complete fence<br>
                â€¢ Click outside a completed fence to start a new one<br>
                â€¢ Multiple fences can coexist on the map<br>
                â€¢ Press 'C' to clear the current fence<br>
                â€¢ Custom fence points can have custom images and colors
            `;
        }
    }
</script>

</body>
</html> 